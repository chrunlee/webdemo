/*
	@company 博育云
	@site : www.boyuyun.cn
	@author boyuyun
*/

"use strict";var inputsearch=function(a){return new inputsearch.fn.init(a)};inputsearch.fn=inputsearch.prototype={constructor:inputsearch,init:function(a){return this.opts=a,this.render(),this}},inputsearch.fn.init.prototype=inputsearch.fn,inputsearch.fn.check=function(){var a={};if(a=byy.extend(a,this.opts),!a.selector)return byy.error("inputsearch opts->selector is required!"),!1;if("string"==typeof a.selector&&0==$(a.selector).length||"object"==typeof a.selector&&0==a.selector.length)return byy.error("inputsearch not found elements by selector:"+a.selector),!1;var b="string"==typeof a.selector?$(a.selector):a.selector;a.$ele=b;var c=!0;return b.each(function(){if("INPUT"!=$(this)[0].nodeName)return void(c=!1)}),c?a.data||a.remote?(this.opts=a,!0):(byy.error("inputsearch has empty data source"),!1):(byy.error("inputsearch elements is not all input "),!1)},inputsearch.fn.view=function(a){var b=this,c=b.opts,d=c.formatter||"";if(a=a||[],a.length>0){return a.map(function(a){if("function"==typeof d){var b=d(a),c=$(b);return c.attr("id",a.id).attr("title",a.name).data("obj",a),c}var c=$("<li></li>");return c.html(a.name),c.attr("id",a.id).attr("title",a.name).data("obj",a),c})}return[$('<span class="empty">没有检索到数据</span>')]},inputsearch.fn.review=function(a,b){var c,d=this,e=a.width()+10,f=a.height()+4;a.offset().left,a.offset().top;a.next().hasClass("byy-input-search")?c=a.next():(c=$("<ul></ul>"),c.addClass("byy-input-search"),a.after(c)),c.css("width",e).css("top",f);var g=d.view(b);c.html("").append(g),d.select(a),c.find("li").off("click").on("click",function(){var b=$(this);d.checkLi(b),d.setValue(a)})},inputsearch.fn.select=function(a){var b=this,c=a.attr("data-id");a.attr("data-name");if(c&&a.next().hasClass("byy-input-search")){var d=a.next(),e=d.find('li[id="'+c+'"]');b.checkLi(e)}},inputsearch.fn.search=function(a,b){var c=this,d=c.opts,e=d.data,f=d.remote;if(null!=e&&void 0!=e){var g;if(e.length>0&&"object"==typeof e[0]){var h=d.name||"name",i=d.id||"id";g=e.filter(function(a,c){return a[h].indexOf(b)>-1}).map(function(a,b){return{obj:a,name:a[h],id:a[i]}})}else g=e.length>0&&"object"!=typeof e[0]?e.filter(function(a,c){return a.indexOf(b)>-1}).map(function(a,b){return{name:a,id:b}}):[];c.review(a,g)}else if(null!=f&&"string"==typeof f){var j;byy.win&&(j=byy.win.load(1)),$.ajax({url:f,type:"POST",data:{keywords:b}}).done(function(b){byy.win&&byy.win.close(j);var d=byy.json(b);d instanceof Array&&c.review(a,d)}).fail(function(b){byy.win?byy.win.msg("查询错误！"):c.reivew(a,[])})}else if(null!=f&&"function"==typeof f){var k=function(b){c.review(a,b)};f(b,k)}},inputsearch.fn.destroy=function(a){a?a.next().hasClass("byy-input-search")&&a.next().remove():$(".byy-input-search").remove()},inputsearch.fn.checkLi=function(a){if(a.length>0){var b=a.parent();b.find(".byy-this").removeClass("byy-this"),a.addClass("byy-this");var c=b.height(),d=b.offset().top,e=a.height()+10,f=a.offset().top;if(f+e>c+d){var g=f+e-(c+d),h=b.scrollTop();b.scrollTop(g+h)}else if(f<d-1){var h=b.scrollTop();b.scrollTop(h-(d-f))}}},inputsearch.fn.direct=function(a,b){var c,d=this;if(a.next().hasClass("byy-input-search")){c=a.next();if(c.find("li").length>0){var e,f,g=c.find("li.byy-this"),h=g.length>0;if(h){var i=g.index();e=i>0?c.find("li:eq("+(i-1)+")"):c.find("li:last"),f=i<c.find("li").length-1?c.find("li:eq("+(i+1)+")"):c.find("li:first")}else e=c.find("li:last"),f=c.find("li:first");var j;switch(b){case 40:j=f;break;case 38:j=e}j&&d.checkLi(j)}}else if(40==b){var k=a.val();d.search(a,k)}},inputsearch.fn.setValue=function(a){var b=this,c=b.opts,d=c.onClick;if(a.next().hasClass("byy-input-search")){var e=a.next();if(e.find("li.byy-this").length>0){var f=e.find("li.byy-this"),g=f.data("obj"),h=f.attr("id"),i=f.attr("title");a.val(i),a.attr("data-id",h),a.attr("data-name",i),b.destroy(a),d&&"function"==typeof d&&d(g)}}},inputsearch.fn.callback=function(a){var b=this,c=b.opts,d=c.$ele;d.on("keyup",function(a){var c=$(this),d=c.val(),e=a.keyCode;switch(console.log(c),e){case 40:case 39:case 38:case 37:b.direct(c,e);break;case 13:b.setValue(c);break;default:""==d.trim()?b.destroy($(this)):b.search($(this),d)}}),d.on("focus",function(a){$(".byy-input-search").remove();var c=$(this).val();""!=c.trim()&&b.search($(this),c),byy.stope(a)}),$("body").on("click",function(a){var c=a.target||a.srcElement,d=$(c);d.parents(".byy-input-search").length>0||d.hasClass("byy-form-search")||b.destroy(),byy.stope(a)})},inputsearch.fn.render=function(){var a=this;a.check()&&a.callback()},byy.define(function(a){a("inputsearch",inputsearch)});