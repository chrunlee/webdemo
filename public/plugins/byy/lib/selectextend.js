/*
	@company 博育云
	@site : www.boyuyun.cn
	@author boyuyun
*/

var selectextend=function(a){return new selectextend.fn.init(a)};selectextend.val=function(a){var b=$(a).data("self");b?b.val([].slice.call(arguments,1)):error("错误, 请检查selector是否正确!")},selectextend.fn=selectextend.prototype={init:function(a){return this.opts="string"==typeof a?{selector:a}:a,this.callback(),this}};var cls=["byy-select-search-field","byy-select-result","byy-select-item","byy-select-item-ul","byy-select-span","byy-select-tab","close","byy-select-dropdown"],langtxt={noresult:byy.lang.selectextend.noresult,maxmsg:byy.lang.selectextend.maxmsg,search:byy.lang.selectextend.search};selectextend.fn.init.prototype=selectextend.fn,selectextend.fn.checkOpts=function(){var a=this,b=a.opts;return b.selector?(b.$ele=$(b.selector),!0):(byy.error("selectextend must has selector!"),!1)},selectextend.fn.val=function(){var a=this,b=[].slice.call(arguments);if(b.length>0)if(1==b.length&&($.isArray(b[0])?b=b[0]:"string"==typeof b[0]&&(b=b[0].split(","))),a.opts.multi){var c=[];if(b.forEach(function(b){a.mapIdAndVal[b]&&(!a.opts.optionLimits||c.length<a.opts.optionLimits)&&c.push({id:a.mapIdAndVal[b].id,value:b,text:a.mapIdAndVal[b].name})}),c.length>0){$("#"+a.containerId).text("");for(var d in a.optIds)a.optIds[d]=0;c.forEach(function(b){a.optIds[b.id]=1,$("#"+a.containerId).append('<span class="byy-btn small '+cls[5]+'" data-value="'+(b.value||"")+'" aria-target="'+b.id+'" title="'+b.text+'" >'+b.text+'<span class="'+cls[5]+"-"+cls[6]+' by-icon byy-tab-close">&#x1006;</span></span>')}),a.multiCount=c.length}}else if(a.mapIdAndVal[b[0]]){for(var d in a.optIds)a.optIds[d]=0;a.optIds[a.mapIdAndVal[b[0]].id]=1,$("#"+a.containerId).attr("title",a.mapIdAndVal[b[0]].name),$("#"+a.containerId).text(a.mapIdAndVal[b[0]].name),$("#"+a.containerId).attr("data-value",b[0])}},selectextend.fn.generateId=function(a,b){return a+"-"+String.fromCharCode(97+parseInt(26*Math.random()))+String.fromCharCode(97+parseInt(26*Math.random()))+(10*Math.random()).toFixed(0)+String.fromCharCode(97+parseInt(26*Math.random()))+"-"+b},selectextend.fn.position=function(a){if(this.containerId){var b=$("#"+this.containerId).offset().top+$("#"+this.containerId).outerHeight(),c=$("#"+this.containerId).offset().left;return a.offset({top:b,left:c-1}),a.width($("#"+this.containerId).outerWidth()+2),a.css("position","absolute"),a}throw new Error("can not find container!")},selectextend.fn.renderOpt=function(a){var b=this;b.optIds={},b.mapIdAndVal={};var c=function(a,d){switch(d.nodeName){case"OPTGROUP":return'<li class="'+cls[3]+'"><strong>'+d.label+"</strong><ul>"+[].slice.call($(d.children).map(c)).join("")+"</ul></li>";case"OPTION":for(var e=b.generateId("select",d.value);e in b.optIds;)e=b.generateId("select",d.value);return b.optIds[e]=0,b.mapIdAndVal[d.value]={id:e,name:d.text},'<li class="'+cls[2]+'" id="'+e+'" title="'+d.text+'" data-value="'+d.value+'" >'+d.text+"</li>"}};return a.children().map(c)},selectextend.fn.data=function(){if(this.opts.multi){var a=$("#"+this.containerId).find("."+cls[5]).map(function(a,b){var c={};return c.id=$(b).attr("data-value"),c.name=$(b).attr("title"),c});return $.makeArray(a)}var b={};return b.id=$("#"+this.containerId).attr("data-value"),b.name=$("#"+this.containerId).attr("title"),b},selectextend.fn.readData=function(a,b){b&&(this.optIds={},this.mapIdAndVal={});var c=[];if("string"==typeof a&&(a=byy.json(a)),a instanceof Array)for(var d=0;d<a.length;d++){var e=a[d];if(b){for(var f=this.generateId("select",e.id);f in this.optIds;)f=this.generateId("select",e.id);this.optIds[f]=0,this.mapIdAndVal[e.id]={id:f,name:e.name}}c.push('<li class="'+cls[2]+'" data-value="'+e.id+'" title="'+e.name+'" '+(b?'id="'+f+'"':"")+" >"+e.name+"</li>")}return c},selectextend.fn.render=function(a){if(this.opts.remote){this.arr=['<li class="'+cls[4]+'">'+langtxt.search+"</li>"];var b=$(this.opts.selector).find("option:first");this.opts.placeholder||(b.length>0?$("#"+this.containerId).html('<span class="select-placeholder">'+byy.trim(b.text())+"</span>"):$("#"+this.containerId).html('<span class="select-placeholder">'+langtxt.search+"</span>"))}else if(this.opts.multi?($("#"+this.containerId).find("."+cls[5]).remove(),this.opts.placeholder&&$("#"+this.containerId).find(".select-placeholder").show()):$("#"+this.containerId).html(this.opts.placeholder?'<span class="select-placeholder">'+this.opts.placeholder+"</span>":""),this.opts.data&&!a&&(a=this.opts.data),a){var c=this.readData(a,!0);this.arr=c}else this.arr=[].slice.call(this.renderOpt($(this.opts.selector)));var d='<span class="'+cls[7]+' byy-anim-upbit byy-anim" aria-namespace="'+this.containerId+'">  <span class="byy-select-search">    <input type="text" class="'+cls[0]+'">  </span>  <ul class="'+cls[1]+'">';if(d+=this.arr.join(""),d+="  </ul>",d+="</span>",this.dropdown=d,!this.opts.multi&&this.arr.length>0&&!this.opts.placeholder&&!this.opts.remote){var e=$(this.arr[0]);e.hasClass(cls[3])&&(e=e.find("."+cls[2]+":first")),$("#"+this.containerId).attr("title",e.attr("title")),$("#"+this.containerId).text(e.text()),$("#"+this.containerId).attr("data-value",e.attr("data-value")),$(this.opts.selector).data("value",e.attr("data-value")),this.optIds[e.attr("id")]=1}this.opts.multi&&(this.multiCount=0)},selectextend.fn.callback=function(){function a(d,e){e?($("body").on("mousedown."+d,"."+cls[7]+" ."+cls[2],function(a){if(1===a.which){var d=byy.trim($(this).text()),e=$(this).attr("data-value"),f=$(this).attr("id");if(c.multi){"true"===$(this).attr("aria-selected")?($(this).attr("aria-selected",""),b.optIds[f]&&(b.optIds[f]=0),$("#"+b.containerId).find('span[aria-target="'+f+'"]').remove(),0===$("#"+b.containerId).find("."+cls[5]).length&&$("#"+b.containerId).find(".select-placeholder").show()):b.multiCount===b.opts.optionLimits?byy.win?byy.win.msg(byy.formatStr(langtxt.maxmsg,b.opts.optionLimits),{icon:2}):alert(byy.formatStr(langtxt.maxmsg,b.opts.optionLimits)):(b.optIds[f]=1,$(this).attr("aria-selected","true"),$("#"+b.containerId).append('<span class="byy-btn small '+cls[5]+'" data-value="'+(e||"")+'" aria-target="'+f+'" title="'+d+'" >'+d+'<span class="'+cls[5]+"-"+cls[6]+' by-icon byy-tab-close">&#x1006;</span></span>'),$("#"+b.containerId).find("."+cls[5]).length>0&&$("#"+b.containerId).find(".select-placeholder").hide())}else $("#"+b.containerId).attr("title",d),$("#"+b.containerId).text(d),$("#"+b.containerId).attr("data-value",e),1!==b.optIds[f]&&(b.optIds[$("."+cls[7]+" ."+cls[2]+'[aria-selected="true"]').attr("id")]=0,b.optIds[f]=1),$("body").trigger("mousedown.selectextend");$("#"+b.containerId).trigger("change.byy-select")}byy.stope(a)}),$("body").on("keyup."+d,"."+cls[7]+" ."+cls[0],function(a){if(!b.opts.optionLimits||b.multiCount<b.opts.optionLimits){var d=a.target,e=$(d),f=[];if(c.remote)c.remote(e.val(),function(a){f=b.readData(a),$("body ."+cls[7]+" ."+cls[1]).html(f.length>0?f:'<li class="'+cls[4]+'">'+langtxt.noresult+"</li>")});else{for(var g=b.arr,h=0;h<g.length;h++){var i=$(g[h]);if(i.hasClass(cls[3]))i.find(".byy-select-item").each(function(a,c){if(-1===$(c).attr("title").indexOf(e.val()))$(c).remove();else if(b.opts.multi){var d=$(c).attr("id");1===b.optIds[d]&&$(c).attr("aria-selected","true")}}),i.find("."+cls[2]).length>0&&f.push(i);else if(i.hasClass(""+cls[2])&&i.attr("title").indexOf(e.val())>-1){if(b.opts.multi){var j=i.attr("id");1===b.optIds[j]&&i.attr("aria-selected","true")}f.push(i)}}$("body ."+cls[7]+" ."+cls[1]).html(f.length>0?f:'<li class="'+cls[4]+'">'+langtxt.noresult+"</li>")}}}),$("body").on("mousedown.selectextend",function(c){var d=c.currentTarget||c.srcElement;$(d);b.opts.multi&&$(d).hasClass("byy-select-item")||$(d).closest(".byy-select-search").length>0||$(d).closest(".byy-select-container").length>0||$(d).hasClass(cls[4])||(a(b.containerId,!1),$("."+cls[7]).remove(),$("#"+b.containerId).parent().removeClass("byy-triangle-down")),byy.stope(c)})):($("body").off("mousedown."+d,"."+cls[7]+" ."+cls[2]),$("body").off("keyup."+d,"."+cls[7]+" ."+cls[0]),$("body").off("mousedown.selectextend"))}var b=this,c=b.opts,d=c.selector,e=$(d),f=(c.multi,c.placeholder||"");c.optionLimits=parseInt(c.optionLimits),b.disabled=!1,e.data("self",b),"true"===e.attr("multi")?c.multi=!0:c.multi&&e.attr("multi","true"),e.addClass("byy-select-extend"),e.attr("placeholder")&&(f=c.placeholder=e.attr("placeholder")),b.optIds={},b.containerId=b.generateId("select","container");var g=e.width()?'style="width:'+(e.width()+20)+'px"':"",h=$('<span class="byy-select-container">  <span class="byy-select-selection '+(c.multi?"multi-selection":"")+'" tabindex=0 '+g+' ><span class="byy-select-selection-render" id='+b.containerId+' ><span class="select-placeholder" >'+f+"</span></span>"+(c.multi?"":'<span class="span-triangle"></span>')+'</span>  <span class="byy-select-dropdown-wrap"></span></span>');e.after(h),this.render(),e.next().on("focus",".byy-select-selection",function(c){if($("."+cls[7]).length>0){a($("."+cls[7]).attr("aria-namespace"),!1),$("."+cls[7]).remove()}if(!b.disabled){var d=b.position($(b.dropdown));b.opts.optionLimits&&b.multiCount>=b.opts.optionLimits?d.find("."+cls[1]).html('<li class="'+cls[4]+'">'+byy.formatStr(langtxt.maxmsg,b.opts.optionLimits)+"</li>"):d.find("."+cls[2]).each(function(a,c){var d=$(c).attr("id");1===b.optIds[d]?$(c).attr("aria-selected",!0):$(c).attr("aria-selected",!1)}),$("body").append(d),d.find(".byy-select-search ."+cls[0]).focus(),$("#"+b.containerId).parent().addClass("byy-triangle-down"),a(b.containerId,!0),byy.stope(c)}}),$("#"+b.containerId).on("mousedown","."+cls[5]+" ."+cls[5]+"-"+cls[6],function(){var a=$(this),c=a.parent(),d=c.attr("aria-target");b.optIds[d]&&(b.optIds[d]=0),c.remove(),0===$("#"+b.containerId).find("."+cls[5]).length&&$("#"+b.containerId).find(".select-placeholder").show(),$("#"+b.containerId).trigger("change.byy-select")}),$("#"+b.containerId).on("change.byy-select",function(a){if(b.opts.multi){var c=$("#"+b.containerId).find("."+cls[5]).map(function(a,b){return $(b).attr("data-value")}).get();$(b.opts.selector).data("value",c),b.opts.onChange&&b.opts.onChange(c),b.multiCount=c.length}else{var d=$("#"+b.containerId).attr("data-value");$(b.opts.selector).data("value",d),b.opts.onChange&&b.opts.onChange(d)}}),function(){var a=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;if(a){var c=e[0],d={attributes:!0,attributeOldValue:!0,attributeFilter:["select-disabled"]};new a(function(a){a.forEach(function(a){var c=$(a.target).attr("select-disabled");"true"===c?b.disabled=!0:"false"===c&&(b.disabled=!1)}),$("#"+b.containerId).trigger("disabled.byy-select")}).observe(c,d)}else document.addEventListener?$(b.opts.selector)[0].addEventListener("DOMAttrModified",function(a){"select-disabled"===a.attrName&&("true"===a.newValue?b.disabled=!0:b.disabled=!1,$("#"+b.containerId).trigger("disabled.byy-select")),byy.stope(a)}):document.attachEvent&&$(b.opts.selector)[0].attachEvent("onpropertychange",function(a){"select-disabled"===a.propertyName&&(b.disabled="true"===a.srcElement["select-disabled"],$("#"+b.containerId).trigger("disabled.byy-select")),byy.stope(a)})}(),$("#"+b.containerId).on("disabled.byy-select",function(){b.disabled?$(this).addClass("byy-select-disabled"):$(this).removeClass("byy-select-disabled")})},byy.define(function(a){a("selectextend",selectextend)});